<html>
	<head>
		<meta charset="utf-8">
		<meta name="author" content="Generated by (c)BluAge Analyzer">
		<meta name="description" content="Compilation issues raised by the BluAge COBOL Compiler service">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<title>&#169; BluAge Analyzer: Problems report</title>
		
		<link rel="stylesheet" type="text/css" href="3rd-party/twitter-bootstrap/5.0.2/bootstrap.min.css"/>
		<link rel="stylesheet" type="text/css" href="3rd-party/myquery/datatables/bootstrap4/dataTables.bootstrap4.min.css"/>
		<link rel="stylesheet" type="text/css" href="3rd-party/myquery/datatables/buttons/1.6.1/buttons.dataTables.min.css"/>
		<link rel="stylesheet" type="text/css" href="3rd-party/myquery/datatables/select/1.3.1/select.dataTables.min.css"/>
		<link rel="stylesheet" type="text/css" href="3rd-party/select2/4.0.13/select2.min.css" />
		
		<script type="text/javascript" src="3rd-party/myquery/3.7.1/myquery-3.7.1.min.js"></script>
		<script type="text/javascript" src="3rd-party/twitter-bootstrap/5.0.2/bootstrap.min.js"></script>
		<script type="text/javascript" src="3rd-party/myquery/datatables/1.10.20/myquery.dataTables.min.js"></script>
		<script type="text/javascript" src="3rd-party/myquery/datatables/bootstrap4/dataTables.bootstrap4.min.js"></script>
		<script type="text/javascript" src="3rd-party/jszip/2.5.0/jszip.min.js"></script>
		<script type="text/javascript" src="3rd-party/pdfmake/0.1.36/pdfmake.min.js"></script>
		<script type="text/javascript" src="3rd-party/pdfmake/0.1.36/vfs_fonts.js"></script>
		<script type="text/javascript" src="3rd-party/myquery/datatables/buttons/1.6.1/dataTables.buttons.min.js"></script>
		<script type="text/javascript" src="3rd-party/myquery/datatables/buttons/1.6.1/buttons.colVis.min.js"></script>
		<script type="text/javascript" src="3rd-party/myquery/datatables/buttons/1.6.1/buttons.html5.min.js"></script>
		<script type="text/javascript" src="3rd-party/myquery/datatables/buttons/1.6.1/buttons.print.min.js"></script>
		<script type="text/javascript" src="3rd-party/myquery/datatables/select/1.3.1/dataTables.select.min.js"></script>
		<script type="text/javascript" src="3rd-party/select2/4.0.13/select2.min.js"></script>
		
		<style type="text/css" class="init">
			tr {
				cursor: pointer;
			}
			td.details-control {
				background: url('details_open.png') no-repeat center center;
			}
			tr.shown td.details-control {
				background: url('details_close.png') no-repeat center center;
			}
			pre {
				margin-bottom: 0px;
				white-space: pre-wrap;
			}
		</style>
		
		<script>
			
			function getFileName (fileName) {
				var idxFileSep = fileName ? fileName.indexOf('/') : -1;
				return idxFileSep >= 0 ? fileName.substring(idxFileSep+1) : fileName;	
			}
			
			function getOptionalValue (value) {
				return value === undefined || value == null || value.length == 0 ? 'n/a' : value;
			}
			
			// Use to render data in column ; filter column value ; export column value
			function getData (colIdx, value) {
				var val = value;
				if (colIdx == 1) {
					val = getFileName(val);
				} else if (colIdx == 4) {
					val = getOptionalValue(val);
				} else if (colIdx == 7) {
					val = getOptionalValue(val);
				}
				return val;
			}
			
			function exportJira (csv, btnConfig, dt, withDetails) {
				var mapAnchors = new Map();
				var rowsSelected = dt.rows({selected: true});
				var occurrences = 'Occurence'+(rowsSelected.count() > 1 ? 's' : '')+' :'+rowsSelected.count()+'\r\n';
				if (withDetails) {
					occurrences = '{anchor:top}' + occurrences;
				}
				var problemsTable = '\r\n||#||File||Language||Line|ID|Sevrity|Type||Message||\r\n';
				var problemsDetails = '';
				var idx = 1;
				rowsSelected.iterator( 'row', function ( context, index ) {
					var rowData = this.row( index ).data();
					var fileName = getFileName(rowData.fileName);
					var parsingRule = getOptionalValue(parsingRule);
					
					if (withDetails) {
						// Compute panel title
						var panelTitle = '([#top]) ';
						panelTitle += '*#' + idx + '* : '+rowData.language+' - ' + rowData.type + ' - ' + parsingRule + ' - ' + rowData.summary;
						panelTitle = panelTitle.replace('{', '\\{')
						panelTitle = panelTitle.replace('}', '\\}')
						var panelDetail = '{panel:title='+panelTitle+'|borderStyle=dashed|borderColor=#ccc|titleBGColor=#F7D6C1|bgColor=#FFFFCE}'
						
						// Dump bad lines
						var hasBadLines = rowData.badLines && rowData.badLines.length > 0;
						if (hasBadLines) {
							var badLines = '\r\n{code:title='+fileName+' / Line '+rowData.lineNumber+'}';
							for (i in rowData.badLines) {
								badLines += '\r\n';
								badLines += rowData.badLines[i].lineNumber;
								badLines += (rowData.badLines[i].mainBadLine) ? ' -> ' : ' :: ';
								badLines += rowData.badLines[i].lineContent;
							}
							badLines += '\r\n{code}';
							panelDetail += badLines;
						}
						
						// Dump message
						var hasMessage = rowData.message && rowData.message.length > 0;
						if (hasMessage) {
							var message = '\r\n{code}';
							for (i in rowData.message) {
								message += '\r\n';
								var cleanMessageLine = rowData.message[i];
								cleanMessageLine = cleanMessageLine.replace('{', ' { ');
								cleanMessageLine = cleanMessageLine.replace('}', ' } ');
								message += cleanMessageLine;
							}
							message += '\r\n{code}';
							panelDetail += message;
						}
						
						// Dump error cause 
						var hasErrorCause = rowData.errorCause && rowData.errorCause.length > 0;
						if (hasErrorCause) {
							var errorCause = '\r\n{code}';
							for (i in rowData.errorCause) {
								errorCause += '\r\n';
								errorCause += rowData.errorCause[i];
							}
							errorCause += '\r\n{code}';
							panelDetail += errorCause;
						}
						panelDetail += '\r\n{panel}';
						problemsDetails += '\r\n{anchor:' +idx + '}'+panelDetail+'\r\n';
					}
					// Add row to jira table for this problem
					problemsTable += '|' + (withDetails ? ('[#' + idx + ']') : idx);
					problemsTable += '|' + fileName;
					problemsTable += '|' + rowData.language;
					problemsTable += '|' + rowData.lineNumber;
                    problemsTable += '|' + rowData.errorID;
                    problemsTable += '|' + rowData.severity;
					problemsTable += '|' + rowData.type;
                    problemsTable += '|' + rowData.subtype;
					problemsTable += '|' + rowData.summary;
					problemsTable += '|\r\n';
					
					idx++;
				});
				return occurrences + problemsTable + problemsDetails;
			}
		
			// Function used to display numbers with spaces and .
			function numberWithSpaces(x) {
			    var parts = x.toString().split(".");
			    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, " ");
			    return parts.join(".");
			}
			
			// Function use to display problem details
			function format ( d ) {
				if (d === undefined) {
					return;
				}
				var details = '';
				details += '<table class="table table-bordered" style="padding-left:50px;">';
				
				// Add bad lines
				var nbDigits = 0;
				if (d.badLines && d.badLines.length > 0) {
					nbDigits = d.badLines[d.badLines.length - 1].lineNumber.length
				}
				if (nbDigits > 0) {
					var badLines = '  ';
					for (var i = 1 ; i <= nbDigits ; i ++) {
						badLines +=  ' ';
					}
					badLines += '  ';
					badLines += '<span style="color:grey;">----+----1----+----2----+----3----+----4----+----5----+----6----+----7--</span>';
					for (idx in d.badLines) {
						badLines += '\r\n';
						if (d.badLines[idx].mainBadLine) {
							badLines += '<span style="color:red;">&rarr; '
						} else {
							badLines += '  '
						}
						badLines += d.badLines[idx].lineNumber;
						badLines += ': ';
						badLines += d.badLines[idx].lineContent;
						if (d.badLines[idx].mainBadLine) {
							badLines += '</span>'
						}
					}
					details += '<tr class="table-primary"><td><pre>Lines</pre></td><td><pre>'+badLines+'</pre></td></tr>';
				}
				
				// Add message
				var message = '';
				if (d.message && d.message.length > 0) {
					for (idx in d.message) {
						if (message.length > 0) {
							message += '\r\n';
						}
						message += d.message[idx];
					}
					details += '<tr class="table-warning"><td><pre>Message</pre></td><td><div style="max-height:250px; overflow:auto;"><pre>';
					details += message;
					details +='</pre></div></td></tr>';
				}
				
				// Add error cause
				var errorCause = '';
				if (d.errorCause && d.errorCause.length > 0) {
					for (idx in d.errorCause) {
						if (errorCause.length > 0) {
							errorCause += '\r\n';
						}
						errorCause += d.errorCause[idx];
					}
					details += '<tr class="table-danger"><td><pre>Error cause</pre></td><td><pre><div style="max-height:250px; overflow:auto;">';
					details += errorCause;
					details += '</pre></td></tr>';
				}
				
				details += '</table>';
				return details;
			}
			
			$(document).ready(function() {
				// Create datatable object and load information using ajax
				var table = $('#problems').DataTable( {
					"ajax": "problems.json",
					"deferRender": true,
					"columns": [
						{
							"className":      'details-control',
							"orderable":      false,
							"data":           null,
							"defaultContent": ''
						}, { 
							"data": "fileName" 
						}, { 
							"data": "language" 
						}, { 
							"data": "lineNumber" 
						}, { 
							"data": "errorID" 
						}, { 
							"data": "severity" 
						}, { 
							"data": "type" 
						}, { 
							"data": "subtype" 
						}, { 
							"data": "summary" 
						}
					],
					"columnDefs": [ 
						{
							"targets": 1,
							"render": function ( data, type, row ) {
								return getData(1, data);
							},
						}, {
							"targets": 4,
							"render": function ( data, type, row ) {
								return getData(4, data);
							},
						}, {
							"targets": 7,
							"render": function ( data, type, row ) {
								return getData(7, data);
							},
						}
					],
					"order": [
						[ 1, "asc" ],
						[ 3, 'asc' ]
					],
					"lengthMenu": [
						[10, 25, 50, 100, 500, -1], 
						[10, 25, 50, 100, 500, "All"]
					],
					select: 'multi',
					dom: 'Bfrtip',
					buttons: [
						'pageLength', 
						{
							extend: 'collection', 
							text: 'Selection &darr;', 
							autoClose: true, 
							className:'text-info',
							buttons: [
								{
									text: 'Select filtered', 
									action: function ( e, dt, node, config ) {
										table.rows( { search: 'applied' } ).select()
									}
								}, { 
									extend:'selectAll', 
									className:'text-primary' 
								}, { 
									extend:'selectNone', 
									className:'text-danger' 
								}
							]
						}, {
							extend: 'collection', 
							text: 'Export &darr;', 
							autoClose: true, 
							className:'text-info',
							buttons: [ 
								{ 
									extend:'copy',
									exportOptions: { columns: [1,2,3,4,5,6,7,8] } 
								},{ 
									extend:'copy',
									text:'JIRA', 
									className:'text-primary', 
									customize: function (csv, btnConfig, dt) {
										return exportJira(csv, btnConfig, dt, true);
									}
								},{ 
									extend:'copy',
									text:'JIRA-Summary', 
									className:'text-primary', 
									customize: function (csv, btnConfig, dt) {
										return exportJira(csv, btnConfig, dt, false);
									}
								},{ 
									extend:'csv',
									exportOptions: { columns: [1,2,3,4,5,6] },
									className:'text-success',
									filename:'exported-problems',
									newline:'\r\n' 
								}, { 
									extend:'excel',
									exportOptions: { columns: [1,2,3,4,5,6] }, 
									className:'text-success', 
									filename:'exported-problems', 
									title:'Exported problems', 
									sheetName:'problems' 
								}, { 
									extend:'pdf', 
									exportOptions: { columns: [1,2,3,4,5,6] }, 
									className:'text-danger', 
									filename:'exported-problems', 
									title:'Exported problems', 
									orientation:'landscape' 
								}, { 
									extend:'print', 
									exportOptions: { columns: [1,2,3,4,5,6] }, 
									title:'Exported problems' 
								}
							]
						}, {
							extend: 'collection', 
							text: 'Column visibility &darr;', 
							autoClose: true, 
							className:'text-info',
							buttons: [  
								{ 
									extend:'colvis', 
									text:'Modify' 
								}, { 
									extend:'colvisRestore', 
									text:'Restore defaults' 
								} 
							]
						}, {
							extend: 'selected',
							text: 'Keep',
							className:'text-primary',
							action: function ( e, dt, button, config ) {
								var rowsSelected = dt.rows({selected: true});
								var rowsNotSelected = dt.rows({selected: false});
								var msg = '<!> Keep only ';
								msg += rowsSelected.count();
								msg += ' row';
								msg += rowsSelected.count() > 1 ? 's' : '';
								msg += ' ; ';
								msg += rowsNotSelected.count();
								msg += ' other row';
								msg += rowsNotSelected.count() > 1 ? 's' : '';
								msg += ' will be deleted <!>';
								msg += '\r\n Continue ?';
								if ( confirm(msg) ) {
									rowsNotSelected.remove().draw( false );
								}
							}
						}, {
							extend: 'selected',
							text: 'Delete',
							className:'text-danger',
							action: function ( e, dt, button, config ) {
								var rowsSelected = dt.rows({selected: true});
								var msg = '<!> ';
								msg += rowsSelected.count();
								msg += ' row';
								msg += rowsSelected.count() > 1 ? 's' : '';
								msg += ' will be deleted <!>';
								msg += '\r\n Continue ?';
								if ( confirm(msg) ) {
									rowsSelected.remove().draw( false );
								}
							}
						}, {
							text: 'Statistics',
							action: function ( e, dt, node, config ) {
								$( '#statisticsButton' ).click();
							}
						}
					],

					initComplete: function () {
						// Add select2 (select + autocomplete) in footer to filter data table (all except detail column)
						this.api().columns().every( function (colIdx) {
							if (colIdx > 0) {
								var column = this;
								var select = $('<select class="form-control select-filter" style="width: 100%"></select>')
									.appendTo( $(column.footer()) )
									.on( 'change', function () {
										var val = $(this).val();
										if (val) {
											if (val === '[ALL]') {
												// special value All : return all
												val = '';
											} else if (val.startsWith('[NEW] ')) {
												// value from created tag : search using regexp
												val = val.substring(6); 
											} else {
												// value from selection : exact search = escape value + complete regexp
												val = $.fn.dataTable.util.escapeRegex(val); 
												val = '^'+val+'$'; 
											}
										} else {
											// no value : return all
											val = ''; 
										}
										column.search( val, true, false ).draw();
										updateFilters();
									});
								
								// Add all options to select
								select.append( '<option value="[ALL]">All</option>' );
								column.data().unique().sort().each( function ( d, j ) {
									var v = getData(colIdx, d);
									select.append( '<option value="'+v+'">'+v+'</option>' );
								});
								
								// Create select2 component
								$(select).select2({
									  placeholder: 'Filter',
									  allowClear: true,
									  tags: true,
									  createTag: function (params) {
										  var term = $.trim(params.term);
										  if (term === '') {
											  return null;
										  }
										  return {
											  id: '[NEW] '+term,
											  text: term
										  }
									  }
								});
							}
						});
					}
				});
				
				// Update available options from search results (keep terms)
				function updateFilters () {
					$('.select-filter').each(function( index ) {
						var select = $( this );
						var selected = select.val();
						var column = table.column(index + 1, {search:'applied'});
						select.find('option').filter(function() {
							return $(this).val().startsWith('[NEW] ') === false
						}).remove();
						column.data().unique().sort().each( function ( d ) {
							var v = getData(index + 1, d);
							var option = '<option value="'+v+'">'+v+'</option>';
							if (d === selected) {
								option = option.replace("option ", "option selected ");
							}
							select.append( option );
						});
						var optionAll = '<option value="[ALL]">All</option>';
						if ('[ALL]' === selected) {
							optionAll = optionAll.replace("option ", "option selected ");
						}
						select.append( optionAll );
					});
				}
				
				// Add event listener for opening and closing details
				$('#problems').on('click', 'tbody>tr>td.details-control', function () {
					var tr = $(this).parent();
					var row = table.row( tr );
					if (row.child.isShown()) {
						// This row is already open - close it
						row.child.hide();
						tr.removeClass('shown');
					} else {
						// Open this row
						row.child( format(row.data()) ).show();
						tr.addClass('shown');
					}
				});
				
				$('#statisticsModal').on('show.bs.modal', function (event) {
					var rows = table.rows({search:'applied'});
					
					// Compute map statistics by type / parsing rule
					var files = new Set();
					var stats = new Map();
					rows.every( function () {
						var row = this.data();
						files.add(row.fileName);
						var key = row.type;
						if (row.parsingRule && row.parsingRule !== "") {
							key += '::' + row.parsingRule;
						}
						if (stats[key]) {
							stats[key] = stats[key] + 1;
						} else {
							stats[key] = 1;
						}
					} );
					
					// Build statistics array of object to sort statistics
					var statsArray = [];
					for (key in stats) {
						var type = key;
						var parsingRule = '';
						if (key.indexOf('::') > 0) {
							parsingRule = key.substring(key.indexOf('::')+2);
							type = key.substring(0, key.indexOf('::'));
						}
						statsArray.push({key: key, type: type, parsingRule: parsingRule, count: stats[key]});
					}
					statsArray.sort(function(a, b){return b.count - a.count});
					
					// Build statistics HTML content
					var statsRows = '';
					for (idx in statsArray) {
						statsRows += '<tr>';
						statsRows += '<td class="text-center">'+statsArray[idx].type+'</td>';
						statsRows += '<td class="text-center">'+statsArray[idx].parsingRule+'</td>';
						statsRows += '<td class="text-center">'+numberWithSpaces(statsArray[idx].count)+'</td>';
						statsRows += '</tr>';
					}
					
					// Update modal body
					var modal = $(this);
					modal.find('#statisticsModalLabel').text('Statistics on '+numberWithSpaces(files.size)+' files');
					modal.find('tbody').empty();
					modal.find('tbody').append(statsRows);
					modal.find('tfoot>tr>th').eq(2).empty();
					modal.find('tfoot>tr>th').eq(2).text(numberWithSpaces(rows.count()));
				});
			});
		</script>
	</head>
	<body>
		<!-- Dummy used to load images at start -->
		<img src='details_open.png' style='display:none' />
		<img src='details_close.png' style='display:none' />
		
		<!-- Problems list using DataTable plugin -->
		<div class="row">&nbsp;</div>
		<div class="row">
			<div class="col-sm-1"></div>
			<div class="col-md-10">
				<table id="problems" class="table table-bordered table-hover" style="width:100%">
					<thead class="thead-dark">
						<tr>
							<th>Details</th>
							<th>File</th>
							<th>Language</th>
							<th>Line</th>
							<th>ID</th>
							<th>Severity</th>
							<th>Type</th>
							<th>SubType</th>
							<th>Message</th>
						</tr>
					</thead>
					<tfoot class="thead-dark">
						<tr>
							<th>n/a</th>
							<th></th>
							<th></th>
							<th></th>
							<th></th>
							<th></th>
							<th></th>
							<th></th>
							<th></th>
						</tr>
					</tfoot>
				</table>
			</div>
			<div class="col-sm-1">&nbsp;</div>
		</div>
		
		<!-- Statistics using Bootstrap Modal -->
		<button id="statisticsButton" type="button" class="btn btn-primary" data-toggle="modal" data-target="#statisticsModal" style="display:none;">
		  Statistics
		</button>
		<div class="modal fade" id="statisticsModal" tabindex="-1" role="dialog" aria-labelledby="statisticsModalLabel" aria-hidden="true">
		  <div class="modal-dialog" role="document">
			<div class="modal-content">
			  <div class="modal-header">
				<h5 class="modal-title" id="statisticsModalLabel">Statistics</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
				  <span aria-hidden="true">&times;</span>
				</button>
			  </div>
			  <div class="modal-body">
				<table class="table table-bordered table-hover table-sm" style="width:100%">
					<thead class="thead-dark">
						<tr>
							<th class="text-center">Type</th>
							<th class="text-center">Parsing rule</th>
							<th class="text-center">Count</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
					<tfoot class="thead-dark">
						<tr>
							<th class="text-center">TOTAL</th>
							<th class="text-center">TOTAL</th>
							<th class="text-center"></th>
						</tr>
					</tfoot>
				</table>
			  </div>
			</div>
		  </div>
		</div>
	</body>
</html>